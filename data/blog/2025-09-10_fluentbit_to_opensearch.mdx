---
title: 'å¦‚ä½•è®“ AWS EC2 ä¸­çš„ Fluent Bit æˆåŠŸå¯«å…¥ OpenSearchï¼šInternal èˆ‡ IAM Role å…©ç¨®æ–¹å¼'
date: '2025-09-10'
lastmod: '2025-09-10'
tags: ['fluent-bit', 'opensearch', 'aws', 'ec2']
draft: false
summary: 'å¦‚ä½•åœ¨ AWS EC2 ä¸­é…ç½® Fluent Bitï¼Œä¸¦æˆåŠŸå°‡æ—¥èªŒæ•¸æ“šå¯«å…¥ OpenSearchï¼ŒåŒ…æ‹¬ Internal èˆ‡ IAM Role å…©ç¨®æ–¹å¼ã€‚'
layout: PostSimple
bibliography: references-data.bib
canonicalUrl: https://tailwind-nextjs-starter-blog.vercel.app/blog/new-features-in-v1/
---

åœ¨æ—¥å¸¸çš„ DevOps å·¥ä½œä¸­ï¼Œå¸¸è¦‹çš„éœ€æ±‚å°±æ˜¯ **æŠŠ EC2 ä¸Šçš„æ‡‰ç”¨ç¨‹å¼æ—¥èªŒï¼Œé€é Fluent Bitï¼Œå¯«å…¥ Amazon OpenSearch**ï¼Œæ–¹ä¾¿å¾ŒçºŒæœå°‹ã€å‘Šè­¦èˆ‡è¦–è¦ºåŒ–ã€‚

ä¸éè¨±å¤šäººåœ¨é…ç½®çš„æ™‚å€™æœƒé‡åˆ°é¡ä¼¼é€™æ¨£çš„éŒ¯èª¤è¨Šæ¯ï¼š

```
[error] [output:opensearch:opensearch.0] HTTP status=403 URI=/_bulk, response:
{"error":{"root_cause":[{"type":"security_exception","reason":"no permissions for [indices:data/write/bulk] ...
```

é€™ä»£è¡¨ **Fluent Bit é›–ç„¶èƒ½é€£ç·šåˆ° OpenSearchï¼Œä½†æ²’æœ‰å¯«å…¥ç´¢å¼•çš„æ¬Šé™**ã€‚
è¦è§£æ±ºé€™å€‹å•é¡Œï¼Œé€šå¸¸æœ‰å…©æ¢è·¯å¯ä»¥èµ°ï¼š

- **æ–¹æ³•ä¸€ï¼šInternal å¸³è™Ÿ**
- **æ–¹æ³•äºŒï¼šAWS IAM Roleï¼ˆæ¨è–¦é›²ç«¯åŸç”Ÿç’°å¢ƒï¼‰**

---

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Internal å¸³è™Ÿæˆæ¬Š

é€™ç¨®æ–¹å¼æ¯”è¼ƒç›´è¦ºï¼Œå°±æ˜¯ç›´æ¥åœ¨ OpenSearch Dashboards å…§å»ºç«‹ä½¿ç”¨è€…ï¼Œä¸¦è³¦äºˆè§’è‰²ã€‚

### æ­¥é©Ÿ

1. **å»ºç«‹å¸³è™Ÿ**

   - ç™»å…¥ OpenSearch Dashboards
   - `Security` â†’ `Internal users` â†’ å»ºç«‹æ–°å¸³è™Ÿï¼Œä¾‹å¦‚ï¼š

     ```
     username: fluentbit
     password: xxxxxx
     ```

2. **å»ºç«‹è§’è‰²ä¸¦åˆ†é…æ¬Šé™**

   - `Security` â†’ `Roles` â†’ å»ºç«‹è§’è‰² `fluentbit_writer`
   - æ¬Šé™è‡³å°‘åŒ…å«ï¼š

     - `indices:data/write/bulk`
     - `indices:admin/create`
     - `indices:admin/mapping/put`

3. **å°‡ä½¿ç”¨è€…åŠ å…¥è§’è‰²**

   - åœ¨è§’è‰²çš„ **Mapped users** è£¡åŠ å…¥ `fluentbit`

4. **è¨­å®š Fluent Bit**

   ```ini
   [OUTPUT]
       Name            opensearch
       Match           *
       Host            your-opensearch-domain.amazonaws.com
       Port            443
       TLS             On
       AWS_Auth        Off
       HTTP_User       fluentbit
       HTTP_Passwd     xxxxxx
       Index           fluentbit-logs
   ```

ğŸ‘‰ å„ªé»ï¼šå¿«é€Ÿï¼Œå®¹æ˜“æ¸¬è©¦ã€‚
ğŸ‘‰ ç¼ºé»ï¼šå¸³å¯†è¦å¯«åœ¨è¨­å®šæª”è£¡ï¼Œå®‰å…¨æ€§è¼ƒå·®ã€‚

---

## æ–¹æ³•äºŒï¼šä½¿ç”¨ AWS IAM Role (æ¨è–¦)

å¦‚æœ EC2 æ˜¯åœ¨ AWS ç’°å¢ƒå…§é‹è¡Œï¼Œå»ºè­°ä½¿ç”¨ IAM Role çš„æ–¹å¼æˆæ¬Šï¼Œé¿å…æ˜ç¢¼å¸³å¯†ï¼Œä¹Ÿæ›´å¥½ç®¡ç†ã€‚

### æ­¥é©Ÿä¸€ï¼šå»ºç«‹ IAM Policy

Terraform ç¯„ä¾‹ï¼š

```hcl
resource "aws_iam_policy" "ec2_to_access_opensearch_policy" {
  name        = "ec2_to_access_opensearch_policy"
  description = "Policy for EC2 Fluent Bit to write logs into OpenSearch"
  policy      = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid    = "AllowLogToOpensearch",
        Effect = "Allow",
        Action = [
          "es:ESHttpPost",
          "es:ESHttpPut",
          "es:ESHttpGet"
        ],
        Resource = [
          "${var.chainss_aws_opensearch_arn}/*"
        ]
      }
    ]
  })
}
```

æŠŠé€™å€‹ Policy attach åˆ° EC2 çš„ Instance Roleï¼ˆä¾‹å¦‚ `CloudWatchAgentServerRole`ï¼‰ã€‚

---

### æ­¥é©ŸäºŒï¼šè¨­å®š Fluent Bit

åœ¨ EC2 ä¸Šçš„ Fluent Bit é…ç½®æª”ï¼Œå•Ÿç”¨ AWS IAM Authï¼š

```ini
[OUTPUT]
    Name            opensearch
    Match           *
    Host            your-opensearch-domain.amazonaws.com
    Port            443
    TLS             On
    AWS_Auth        On
    AWS_Region      ap-northeast-1
    Index           fluentbit-logs
```

é€™æ™‚å€™ Fluent Bit æœƒå˜—è©¦ä½¿ç”¨ EC2 instance profile çš„ IAM Role ä¾†ç°½ç½² requestã€‚
å¦‚æœé¦¬ä¸Šå•Ÿå‹• Fluent Bitï¼Œé€šå¸¸æœƒå…ˆçœ‹åˆ° `403 security_exception`ï¼Œå› ç‚º OpenSearch é‚„æ²’èªå¾—é€™å€‹ IAM Roleã€‚

---

### æ­¥é©Ÿä¸‰ï¼šåœ¨ OpenSearch Security Plugin åš Role Mapping

é€™ä¸€æ­¥æ˜¯ **è§£æ±º 403 çš„é—œéµ**ã€‚

1. ç™»å…¥ OpenSearch Dashboards â†’ `Security` â†’ `Roles`
   å»ºç«‹æˆ–ä¿®æ”¹ä¸€å€‹è§’è‰²ï¼Œä¾‹å¦‚ `fluentbit_role`ï¼Œæ¬Šé™è‡³å°‘åŒ…å«ï¼š

   - `indices:data/write/bulk`
   - `indices:admin/create`
   - `indices:admin/mapping/put`

   é» Security
   ![image](/static/images/2025-09-10_fluentbit_to_opensearch/1.png)
   é» Roles
   ![image](/static/images/2025-09-10_fluentbit_to_opensearch/2.png)
   é€²å» Role
   ![image](/static/images/2025-09-10_fluentbit_to_opensearch/3.png)

2. åœ¨è©²è§’è‰²çš„ **Mapped users**ï¼ŒåŠ å…¥ EC2 ä½¿ç”¨çš„ IAM Role ARNï¼Œä¾‹å¦‚ï¼š

   ```
   arn:aws:iam::637423529854:role/CloudWatchAgentServerRole
   ```

   é€™æ¨£ OpenSearch å°±æœƒæŠŠä¾†è‡ªé€™å€‹ IAM Role çš„è«‹æ±‚è¦–ç‚º `fluentbit_role`ï¼Œå…è¨±å¯«å…¥ç´¢å¼•ã€‚

   é» Mapped users
   ![image](/static/images/2025-09-10_fluentbit_to_opensearch/4.png)
   æœ€å¾Œæœƒé•·é€™æ¨£å°±å®Œæˆäº†
   ![image](/static/images/2025-09-10_fluentbit_to_opensearch/5.png)

---

## 403 éŒ¯èª¤æ’æŸ¥ Checklist

å¦‚æœé‡åˆ° `403 security_exception`ï¼Œå¯ä»¥ç…§ä»¥ä¸‹é †åºæª¢æŸ¥ï¼š

1. **IAM Policy æ˜¯å¦æ­£ç¢º**

   - æ˜¯å¦åŒ…å« `es:ESHttpPost`ã€`es:ESHttpPut`
   - Resource ARN æ˜¯å¦æ­£ç¢ºï¼ˆè¦åˆ°ç´¢å¼•å±¤ç´š `/*`ï¼‰

2. **Fluent Bit æ˜¯å¦å•Ÿç”¨äº†æ­£ç¢ºçš„èªè­‰æ–¹å¼**

   - Internal å¸³è™Ÿ â†’ `AWS_Auth Off` + `HTTP_User` / `HTTP_Passwd`
   - IAM Role â†’ `AWS_Auth On` + `AWS_Region`

3. **OpenSearch Security Role æ˜¯å¦æœ‰è¶³å¤ çš„ç´¢å¼•æ¬Šé™**

4. **æ˜¯å¦æ­£ç¢º Mapping åˆ° IAM Role ARN**

   - `Security â†’ Roles â†’ Mapped users` è£¡è¦çœ‹åˆ° EC2 çš„ Role ARN

---

## ç¸½çµ

- **Internal å¸³è™Ÿ**ï¼šç°¡å–®å¿«é€Ÿï¼Œé©åˆæ¸¬è©¦ï¼Œä½†éœ€è¦åœ¨è¨­å®šæª”è£¡æ”¾å¸³å¯†ã€‚
- **IAM Role**ï¼šç¬¦åˆé›²ç«¯æœ€ä½³å¯¦è¸ï¼Œå®‰å…¨æ€§é«˜ï¼Œæ­£å¼ç’°å¢ƒå»ºè­°ä½¿ç”¨ã€‚
- **Role Mapping æ˜¯é—œéµ**ï¼šå¦‚æœæ²’æœ‰åœ¨ OpenSearch Security è£¡æŠŠ IAM Role ARN map åˆ°å°æ‡‰è§’è‰²ï¼Œå³ä½¿ IAM Policy æ­£ç¢ºï¼Œä¹Ÿä¸€æ¨£æœƒ 403ã€‚
