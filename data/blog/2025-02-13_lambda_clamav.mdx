---
title: 'åœ¨ Lambda ä¸­è™•ç† ClamAV æƒæçµæœä¸¦é€šé SNS ç™¼é€é€šçŸ¥'
date: '2025-02-13'
lastmod: '2025-02-13'
tags: ['aws', 'lambda', 'clamav', 'sns']
draft: false
summary: 'é€™å€‹ Lambda å‡½æ•¸ä¸»è¦ç”¨æ–¼è™•ç† ClamAV é˜²æ¯’è»Ÿé«”çš„æƒæçµæœï¼Œä¸¦é€šé SNS ç™¼é€é€šçŸ¥åˆ°æŒ‡å®šçš„ä¸»é¡Œã€‚æ•´å€‹æµç¨‹æ˜¯ç”± CloudWatch è§¸ç™¼çš„ã€‚'
layout: PostSimple
bibliography: references-data.bib
canonicalUrl: https://tailwind-nextjs-starter-blog.vercel.app/blog/new-features-in-v1/
---

## åŠŸèƒ½æ¦‚è¿°

é€™å€‹ Lambda å‡½æ•¸ä¸»è¦ç”¨æ–¼è™•ç† ClamAV é˜²æ¯’è»Ÿé«”çš„æƒæçµæœï¼Œä¸¦é€šé SNS ç™¼é€é€šçŸ¥åˆ°æŒ‡å®šçš„ä¸»é¡Œã€‚æ•´å€‹æµç¨‹æ˜¯ç”± CloudWatch è§¸ç™¼çš„ã€‚

## ç³»çµ±æ¶æ§‹

```mermaid
graph LR
    A[ClamAV æƒæ] --> B[CloudWatch Logs]
    B --> C[Lambda å‡½æ•¸]
    C --> D[SNS Topic]
    D --> E[Slack é€šçŸ¥]
```

## ä¸»è¦çµ„ä»¶

1. **CloudWatch Logs**

   - æ—¥èªŒçµ„åç¨±ï¼š`clamscan-log-group`
   - æ”¶é›† ClamAV çš„æƒæçµæœæ—¥èªŒ

2. **Lambda å‡½æ•¸**

   - é‹è¡Œç’°å¢ƒï¼šPython
   - ä¸»è¦åŠŸèƒ½ï¼šè§£ææ—¥èªŒä¸¦æå–æƒæçµæœ

3. **SNS Topic**
   - ARNï¼š`arn:aws:sns:ap-northeast-1:471112694074:Notify_to_Slack`
   - ç”¨æ–¼ç™¼é€é€šçŸ¥åˆ° Slack

## è™•ç†æµç¨‹

1. **æ—¥èªŒè§£ç¢¼æµç¨‹**

   - æ¥æ”¶ base64 ç·¨ç¢¼çš„ CloudWatch æ—¥èªŒ
   - è§£å£“ç¸® gzip æ ¼å¼çš„æ•¸æ“š
   - è§£æ JSON æ ¼å¼çš„æ—¥èªŒå…§å®¹

2. **æƒæçµæœåˆ†æ**

   - ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–æ„ŸæŸ“æ–‡ä»¶æ•¸
   - æ ¹æ“šæ„ŸæŸ“æ–‡ä»¶æ•¸åˆ¤æ–·æƒæç‹€æ…‹
   - ç”Ÿæˆé©ç•¶çš„ç‹€æ…‹æ¶ˆæ¯

3. **é€šçŸ¥ç™¼é€**
   - æ ¼å¼åŒ–é€šçŸ¥æ¶ˆæ¯
   - åŒ…å«å¯¦ä¾‹ ID å’Œæƒæçµæœ
   - é€šé SNS ç™¼é€åˆ°æŒ‡å®šä¸»é¡Œ

## æ¶ˆæ¯æ ¼å¼

### è¼¸å…¥æ—¥èªŒæ ¼å¼

```
----------- SCAN SUMMARY -----------
Known viruses: 8704421
Engine version: 0.103.12
Scanned directories: 1
Scanned files: 2
Infected files: 0
Data scanned: 0.00 MB
Data read: 0.00 MB (ratio 0.00:1)
Time: 31.887 sec (0 m 31 s)
Start Date: 2025:02:12 08:25:57
End Date:   2025:02:12 08:26:29
```

### è¼¸å‡ºæ¶ˆæ¯æ ¼å¼

```
Instance ID: `[å¯¦ä¾‹ID]`
âœ… æƒæå®Œæˆï¼Œæœªç™¼ç¾ç—…æ¯’ã€‚
```

æˆ–

```
Instance ID: `[å¯¦ä¾‹ID]`
ğŸ¦  ç™¼ç¾ç—…æ¯’ï¼è«‹ç«‹å³è™•ç†ã€‚
```

## éŒ¯èª¤è™•ç†

- å®Œæ•´çš„ç•°å¸¸æ•ç²å’Œæ—¥èªŒè¨˜éŒ„
- è¿”å›é©ç•¶çš„ HTTP ç‹€æ…‹ç¢¼
- è©³ç´°çš„éŒ¯èª¤æ¶ˆæ¯è¨˜éŒ„

## æ³¨æ„äº‹é …

1. ç¢ºä¿ Lambda å‡½æ•¸æœ‰é©ç•¶çš„ IAM æ¬Šé™ï¼š

   - CloudWatch Logs è®€å–æ¬Šé™
   - SNS ç™¼å¸ƒæ¬Šé™

2. å»ºè­°è¨­ç½®ç›£æ§ï¼š

   - Lambda åŸ·è¡Œè¶…æ™‚
   - éŒ¯èª¤ç‡ç›£æ§
   - CloudWatch Logs ä¿ç•™æœŸé™

3. æœ€ä½³å¯¦è¸ï¼š
   - å®šæœŸæ›´æ–° Python ä¾è³´åŒ…
   - ç›£æ§ SNS ç™¼é€å¤±æ•—æƒ…æ³
   - ä¿æŒæ—¥èªŒæ ¼å¼ä¸€è‡´æ€§

## ç¨‹å¼ç¢¼å±•ç¤º

```python=
import json
import boto3
import base64
import gzip
import logging
import re

sns_client = boto3.client('sns')
log_group_name = 'clamscan-log-group'
sns_topic_arn = 'arn:aws:sns:ap-northeast-1:000000000000:Notify_to_Slack'

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger()

def get_scan_result(message):
    """å¾æƒææ—¥èªŒä¸­æå–æ„ŸæŸ“æ–‡ä»¶æ•¸"""
    match = re.search(r"Infected files: (\d+)", message)
    if match:
        return int(match.group(1))
    return 0

def lambda_handler(event, context):
    try:
        logger.info("Original event: %s", json.dumps(event, indent=2))

        compressed_payload = base64.b64decode(event['awslogs']['data'])
        uncompressed_payload = gzip.decompress(compressed_payload)
        log_data = json.loads(uncompressed_payload)

        if 'logEvents' not in log_data:
            logger.error("No logEvents found in log_data")
            return {
                'statusCode': 400,
                'body': json.dumps('No log events found')
            }

        # ç²å–æ‰€æœ‰æ—¥èªŒæ¶ˆæ¯
        combined_messages = []
        latest_timestamp = 0
        for log_event in log_data['logEvents']:
            combined_messages.append(log_event['message'])
            latest_timestamp = max(latest_timestamp, log_event['timestamp'])

        # å°‡æ‰€æœ‰æ¶ˆæ¯åˆä½µæˆä¸€å€‹å­—ç¬¦ä¸²
        full_message = '\n'.join(combined_messages)

        # æª¢æŸ¥æ˜¯å¦æœ‰ç—…æ¯’
        infected_files = get_scan_result(full_message)
        status_message = "âœ… æƒæå®Œæˆï¼Œæœªç™¼ç¾ç—…æ¯’ã€‚" if infected_files == 0 else "ğŸ¦  ç™¼ç¾ç—…æ¯’ï¼è«‹ç«‹å³è™•ç†ã€‚"

        # å‰µå»ºæ ¼å¼åŒ–çš„æ¶ˆæ¯
        formatted_message = (
            f"Instance ID : `{log_data.get('logStream', 'N/A')}`\n"
            f"{status_message}"
        )

        # ç™¼é€ SNS é€šçŸ¥
        sns_message = {
            "version": "1.0",
            "source": "custom",
            "content": {
                "description": formatted_message
            },
            'timestamp': latest_timestamp,
            'message': formatted_message
        }

        sns_client.publish(
            TopicArn=sns_topic_arn,
            Message=json.dumps(sns_message),
            Subject='ClamAV æƒæçµæœé€šçŸ¥'
        )

    except Exception as e:
        logger.error(f"Error occurred: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps(f'Error processing log: {str(e)}')
        }

    return {
        'statusCode': 200,
        'body': json.dumps('Log processed successfully')
    }
```
