---
title: 'Kubernetes + AWS EFS Vault éƒ¨ç½²å®Œæ•´æµç¨‹åˆ†äº«'
date: '2025-09-16'
lastmod: '2025-09-16'
tags: ['vault', 'kubernetes', 'aws', 'efs']
draft: false
summary: 'å¦‚ä½•åœ¨ Kubernetes ç’°å¢ƒä¸­éƒ¨ç½² AWS EFS èˆ‡ HashiCorp Vaultï¼Œä¸¦é€²è¡Œæ•´åˆã€‚'
layout: PostSimple
bibliography: references-data.bib
canonicalUrl: https://tailwind-nextjs-starter-blog.vercel.app/blog/new-features-in-v1/
---

åœ¨ Kubernetes ä¸Šéƒ¨ç½²æœ‰ç‹€æ…‹æœå‹™ï¼ˆä¾‹å¦‚ Vaultï¼‰ï¼Œéœ€è¦æŒä¹…åŒ–å„²å­˜ã€‚è‹¥ä½¿ç”¨ **AWS EFS + CSI Driver**ï¼Œæ•´å€‹æµç¨‹å¯ä»¥è‡ªå‹•åŒ–ï¼Œçœå»æ‰‹å‹•å»ºç«‹ PV / Access Point çš„éº»ç…©ã€‚ä»¥ä¸‹æ•´ç†æ•´å€‹éƒ¨ç½²æµç¨‹èˆ‡åŸç†ã€‚

---

## ğŸ”‘ å»ºç«‹é †åºèˆ‡æ¦‚å¿µ

### 1ï¸âƒ£ å®‰è£ AWS EFS CSI Driver

Vault éœ€è¦æŒä¹…åŒ–å„²å­˜ï¼Œåœ¨ EKS Fargate ä¸­åƒ…æ”¯æ´ AWS EFSã€‚è«‹å…ˆå®‰è£ EFS CSI Driverï¼š

```bash
# è©³è¦‹å®˜æ–¹èªªæ˜
https://github.com/kubernetes-sigs/aws-efs-csi-driver
```

- **åŠŸèƒ½**ï¼šæ”¯æ´ Kubernetes Pod æ›è¼‰ AWS EFSï¼Œä¸¦å¯å‹•æ…‹å»ºç«‹ PV èˆ‡ Access Pointã€‚

---

### 2ï¸âƒ£ å»ºç«‹ StorageClass

StorageClass æ˜¯ Kubernetes çš„å­˜å„²é…ç½®ï¼ŒæŒ‡å®š EFS CSI Driver å’Œå‹•æ…‹ç”Ÿæˆ Access Point çš„åƒæ•¸ã€‚

```yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: vault-efs
provisioner: efs.csi.aws.com
parameters:
  fileSystemId: fs-xxxxxxxx # EFS ID
  provisioningMode: efs-ap # é—œéµï¼šè‡ªå‹•å»ºç«‹ Access Point
  directoryPerms: '755'
  uid: '100'
  gid: '100'
reclaimPolicy: Retain
volumeBindingMode: Immediate
```

- å¥—ç”¨ StorageClassï¼š

```bash
kubectl apply -f aws-deployment/vault-step/StorageClass.yaml
```

> ğŸ’¡ æ³¨æ„ï¼šStorageClass å…ˆå»ºç«‹ï¼ŒPVC æ‰èƒ½å‹•æ…‹è§¸ç™¼ PV + Access Point ç”Ÿæˆã€‚

---

### 3ï¸âƒ£ å»ºç«‹ Vault Namespace

ç‚º Vault å»ºç«‹å°ˆå±¬å‘½åç©ºé–“ï¼š

```bash
kubectl create namespace vault
```

---

### 4ï¸âƒ£ éƒ¨ç½² Vault æ‡‰ç”¨ç¨‹å¼ï¼ˆPVC / PV / Access Point è‡ªå‹•ç”Ÿæˆï¼‰

- Vault çš„ Helm Chart æˆ– StatefulSet YAML æœƒè‡ªå‹•å»ºç«‹ PVCï¼Œä¾‹å¦‚ï¼š

```
data-vault-0
data-vault-1
data-vault-2
```

- PVC æŒ‡å‘ `vault-efs` StorageClass â†’ **EFS CSI Driver æœƒè‡ªå‹•å»ºç«‹å°æ‡‰ PV + Access Point**
- ä¸éœ€è¦æ‰‹å‹•å»ºç«‹ PV æˆ– Access Point

éƒ¨ç½² Vaultï¼š

```bash
kubectl apply -f aws-deployment/application/vault.yaml
```

- **æŸ¥è©¢å·²å»ºç«‹çš„ PVC**ï¼š

```bash
kubectl get pvc -n vault
```

æœƒçœ‹åˆ°é¡ä¼¼ï¼š

```
NAME           STATUS   VOLUME                                     STORAGECLASS
data-vault-0   Bound    pvc-220fe126-8ad9-4ed3-b037-4e62cd6bcce1   vault-efs
data-vault-1   Bound    pvc-04ac92db-fa52-4f40-90e6-e44b3ec782d1   vault-efs
data-vault-2   Bound    pvc-c436b7f0-0e50-4778-8346-30b4ef8d396c   vault-efs
```

- **æŸ¥è©¢ PV èˆ‡å°æ‡‰ Access Point**ï¼š

```bash
kubectl get pv
kubectl describe pv <pv-name>
```

- AWS æ§åˆ¶å°ä¹Ÿå¯çœ‹åˆ°è‡ªå‹•å»ºç«‹çš„ **EFS Access Point**ã€‚

---

### 5ï¸âƒ£ é…ç½® AWS KMS è‡ªå‹•è§£å°

- å»ºç«‹ KMS Keyï¼Œå–å¾— `kms_id`
- å¡«å…¥ Vault YAML `seal "awskms"` å€æ®µï¼Œä»¥æ”¯æ´è‡ªå‹•è§£å°

---

### 6ï¸âƒ£ åˆå§‹åŒ– Vault

é€²å…¥ `vault-0` Podï¼š

```bash
kubectl -n vault exec -it vault-0 -- vault operator init
```

- æœƒç”¢ç”Ÿ **5 å€‹ Unseal Key** å’Œ **Root Token**ï¼Œè«‹å¦¥å–„ä¿å­˜

---

### 7ï¸âƒ£ åŒæ­¥ Vault Raft é›†ç¾¤

å°‡å…¶ä»–ç¯€é»åŠ å…¥ Raft é›†ç¾¤ï¼š

1. åœ¨ `vault-1` / `vault-2` Pod ä¸Šè¨­å®šç’°å¢ƒè®Šæ•¸ï¼š

```bash
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=<Root Token>
```

2. åŠ å…¥ Raft é›†ç¾¤ï¼š

```bash
vault operator raft join http://vault-0.vault-internal:8200
vault operator unseal    # è¼¸å…¥å…¶ä¸­ä¸€çµ„ Unseal Key
vault operator raft list-peers
```

3. ç¢ºèªé›†ç¾¤ç‹€æ…‹ï¼š

```text
Node       Address                        State       Voter
----       -------                        -----       -----
vault-0    vault-0.vault-internal:8201    leader      true
vault-1    vault-1.vault-internal:8201    follower    true
vault-2    vault-2.vault-internal:8201    follower    true
```

---

## ğŸ”‘ å‹•æ…‹å­˜å„²åŸç†

1. **StorageClass** â†’ è¨­å®š EFS CSI Driver ä»¥åŠå‹•æ…‹ç”Ÿæˆ Access Point çš„è¦å‰‡
2. **PVC** â†’ App å»ºç«‹ PVC å¾Œï¼Œè§¸ç™¼ CSI Driver å»ºç«‹ PV + Access Point
3. **PV** â†’ è‡ªå‹•ç”Ÿæˆï¼Œç¶å®š PVC
4. **Access Point** â†’ è‡ªå‹•ç”Ÿæˆï¼ŒPod æ›è¼‰ä½¿ç”¨

**æµç¨‹åœ–**ï¼š

```
App (StatefulSet / Helm) â†’ å»ºç«‹ PVC
PVC â†’ æ‰¾ StorageClass (vault-efs)
EFS CSI Driver â†’ å»ºç«‹ PV + EFS Access Point
PVC â†” PV ç¶å®š
Pod â†’ æ›è¼‰ EFS Access Point
```

> âœ… ä¹Ÿå°±æ˜¯èªªï¼Œé™¤äº† StorageClass è¦ä½ å…ˆå»ºï¼Œå…¶ä»– PVC / PV / Access Point éƒ½æœƒåœ¨ä½  apply App YAML ä¹‹å¾Œè‡ªå‹•ç”Ÿæˆã€‚

---

é€™æ¨£æ•´å€‹ Vault éƒ¨ç½²æµç¨‹å°±å®Œæ•´äº†ï¼š

- StorageClass å…ˆå»º
- PVC éš¨ Helm / StatefulSet å»ºç«‹ä¸¦å¯æŸ¥è©¢
- PV + Access Point è‡ªå‹•ç”Ÿæˆ
- Vault Pod æ›è¼‰å¾Œå³å¯ä½¿ç”¨æŒä¹…åŒ–å­˜å„²
