---
title: 'Kubernetes + AWS EFS Vault 部署完整流程分享'
date: '2025-09-16'
lastmod: '2025-09-16'
tags: ['vault', 'kubernetes', 'aws', 'efs']
draft: false
summary: '如何在 Kubernetes 環境中部署 AWS EFS 與 HashiCorp Vault，並進行整合。'
layout: PostSimple
bibliography: references-data.bib
canonicalUrl: https://tailwind-nextjs-starter-blog.vercel.app/blog/new-features-in-v1/
---

在 Kubernetes 上部署有狀態服務（例如 Vault），需要持久化儲存。若使用 **AWS EFS + CSI Driver**，整個流程可以自動化，省去手動建立 PV / Access Point 的麻煩。以下整理整個部署流程與原理。

---

## 🔑 建立順序與概念

### 1️⃣ 安裝 AWS EFS CSI Driver

Vault 需要持久化儲存，在 EKS Fargate 中僅支援 AWS EFS。請先安裝 EFS CSI Driver：

```bash
# 詳見官方說明
https://github.com/kubernetes-sigs/aws-efs-csi-driver
```

- **功能**：支援 Kubernetes Pod 掛載 AWS EFS，並可動態建立 PV 與 Access Point。

---

### 2️⃣ 建立 StorageClass

StorageClass 是 Kubernetes 的存儲配置，指定 EFS CSI Driver 和動態生成 Access Point 的參數。

```yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: vault-efs
provisioner: efs.csi.aws.com
parameters:
  fileSystemId: fs-xxxxxxxx # EFS ID
  provisioningMode: efs-ap # 關鍵：自動建立 Access Point
  directoryPerms: '755'
  uid: '100'
  gid: '100'
reclaimPolicy: Retain
volumeBindingMode: Immediate
```

- 套用 StorageClass：

```bash
kubectl apply -f aws-deployment/vault-step/StorageClass.yaml
```

> 💡 注意：StorageClass 先建立，PVC 才能動態觸發 PV + Access Point 生成。

---

### 3️⃣ 建立 Vault Namespace

為 Vault 建立專屬命名空間：

```bash
kubectl create namespace vault
```

---

### 4️⃣ 部署 Vault 應用程式（PVC / PV / Access Point 自動生成）

- Vault 的 Helm Chart 或 StatefulSet YAML 會自動建立 PVC，例如：

```
data-vault-0
data-vault-1
data-vault-2
```

- PVC 指向 `vault-efs` StorageClass → **EFS CSI Driver 會自動建立對應 PV + Access Point**
- 不需要手動建立 PV 或 Access Point

部署 Vault：

```bash
kubectl apply -f aws-deployment/application/vault.yaml
```

- **查詢已建立的 PVC**：

```bash
kubectl get pvc -n vault
```

會看到類似：

```
NAME           STATUS   VOLUME                                     STORAGECLASS
data-vault-0   Bound    pvc-220fe126-8ad9-4ed3-b037-4e62cd6bcce1   vault-efs
data-vault-1   Bound    pvc-04ac92db-fa52-4f40-90e6-e44b3ec782d1   vault-efs
data-vault-2   Bound    pvc-c436b7f0-0e50-4778-8346-30b4ef8d396c   vault-efs
```

- **查詢 PV 與對應 Access Point**：

```bash
kubectl get pv
kubectl describe pv <pv-name>
```

- AWS 控制台也可看到自動建立的 **EFS Access Point**。

---

### 5️⃣ 配置 AWS KMS 自動解封

- 建立 KMS Key，取得 `kms_id`
- 填入 Vault YAML `seal "awskms"` 區段，以支援自動解封

---

### 6️⃣ 初始化 Vault

進入 `vault-0` Pod：

```bash
kubectl -n vault exec -it vault-0 -- vault operator init
```

- 會產生 **5 個 Unseal Key** 和 **Root Token**，請妥善保存

---

### 7️⃣ 同步 Vault Raft 集群

將其他節點加入 Raft 集群：

1. 在 `vault-1` / `vault-2` Pod 上設定環境變數：

```bash
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=<Root Token>
```

2. 加入 Raft 集群：

```bash
vault operator raft join http://vault-0.vault-internal:8200
vault operator unseal    # 輸入其中一組 Unseal Key
vault operator raft list-peers
```

3. 確認集群狀態：

```text
Node       Address                        State       Voter
----       -------                        -----       -----
vault-0    vault-0.vault-internal:8201    leader      true
vault-1    vault-1.vault-internal:8201    follower    true
vault-2    vault-2.vault-internal:8201    follower    true
```

---

## 🔑 動態存儲原理

1. **StorageClass** → 設定 EFS CSI Driver 以及動態生成 Access Point 的規則
2. **PVC** → App 建立 PVC 後，觸發 CSI Driver 建立 PV + Access Point
3. **PV** → 自動生成，綁定 PVC
4. **Access Point** → 自動生成，Pod 掛載使用

**流程圖**：

```
App (StatefulSet / Helm) → 建立 PVC
PVC → 找 StorageClass (vault-efs)
EFS CSI Driver → 建立 PV + EFS Access Point
PVC ↔ PV 綁定
Pod → 掛載 EFS Access Point
```

> ✅ 也就是說，除了 StorageClass 要你先建，其他 PVC / PV / Access Point 都會在你 apply App YAML 之後自動生成。

---

這樣整個 Vault 部署流程就完整了：

- StorageClass 先建
- PVC 隨 Helm / StatefulSet 建立並可查詢
- PV + Access Point 自動生成
- Vault Pod 掛載後即可使用持久化存儲
